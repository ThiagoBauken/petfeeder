# Mosquitto MQTT Broker Configuration
# /mosquitto/config/mosquitto.conf

# ==================== GENERAL ====================
per_listener_settings true
allow_anonymous false
sys_interval 10

# ==================== DEFAULT LISTENER ====================
listener 1883
protocol mqtt
max_connections 1000
max_qos 2

# ==================== WEBSOCKET LISTENER ====================
listener 9001
protocol websockets
max_connections 500

# ==================== AUTHENTICATION ====================
password_file /mosquitto/config/passwords.txt
acl_file /mosquitto/config/acl.txt

# Auth plugin for PostgreSQL (optional)
# auth_plugin /mosquitto/plugins/auth-postgres.so
# auth_opt_host postgres
# auth_opt_port 5432
# auth_opt_dbname petfeeder
# auth_opt_user mosquitto
# auth_opt_pass mosquitto_password
# auth_opt_userquery SELECT password FROM mqtt_users WHERE username = $1 AND active = true
# auth_opt_superquery SELECT COUNT(*) FROM mqtt_users WHERE username = $1 AND is_admin = true
# auth_opt_aclquery SELECT topic FROM mqtt_acls WHERE username = $1

# ==================== PERSISTENCE ====================
persistence true
persistence_location /mosquitto/data/
autosave_interval 300
autosave_on_changes true

# ==================== LOGGING ====================
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_type all
log_timestamp true
log_timestamp_format %Y-%m-%d %H:%M:%S

# ==================== SECURITY ====================
clientid_prefixes PF_
max_inflight_messages 20
max_queued_messages 1000
message_size_limit 256000
persistent_client_expiration 1d

# ==================== PERFORMANCE ====================
max_packet_size 256000
receive_maximum 100
send_maximum 100
keepalive_interval 60
max_keepalive 120

# ==================== BRIDGE (Optional) ====================
# connection bridge-to-cloud
# address mqtt.amazonaws.com:8883
# topic devices/# both 2
# bridge_protocol_version mqttv311
# bridge_insecure false
# bridge_cafile /mosquitto/certs/aws-ca.pem
# bridge_certfile /mosquitto/certs/client-cert.pem
# bridge_keyfile /mosquitto/certs/client-key.pem

# ==================== MONITORING ====================
# $SYS topic configuration
sys_interval 10
store_clean_interval 10

# ==================== TLS/SSL (Production) ====================
# listener 8883
# protocol mqtt
# cafile /mosquitto/certs/ca.crt
# certfile /mosquitto/certs/server.crt
# keyfile /mosquitto/certs/server.key
# require_certificate true
# use_identity_as_username true
# tls_version tlsv1.2
