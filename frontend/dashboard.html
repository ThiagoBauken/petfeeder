<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PetFeeder SaaS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1><i class="fas fa-paw"></i> PetFeeder</h1>
        </div>
        <div class="header-right">
            <div class="header-item">
                <i class="fas fa-wifi" id="wifiStatus"></i>
                <span id="connectionStatus">Conectando...</span>
            </div>
            <div class="header-item">
                <i class="fas fa-clock"></i>
                <span id="currentTime">--:--</span>
            </div>
            <div class="header-item">
                <i class="fas fa-user"></i>
                <span id="userName">Usu√°rio</span>
            </div>
            <button class="btn btn-sm" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">
                <i class="fas fa-home"></i> Dashboard
            </button>
            <button class="tab" onclick="switchTab('pets')">
                <i class="fas fa-paw"></i> Meus Pets
            </button>
            <button class="tab" onclick="switchTab('schedules')">
                <i class="fas fa-clock"></i> Hor√°rios
            </button>
            <button class="tab" onclick="switchTab('history')">
                <i class="fas fa-history"></i> Hist√≥rico
            </button>
            <button class="tab" onclick="switchTab('devices')">
                <i class="fas fa-microchip"></i> Dispositivos
            </button>
        </div>

        <!-- Tab Contents -->

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <h2>Dashboard</h2>

            <!-- Alerta de Comida Baixa -->
            <div id="lowFoodAlert" class="alert alert-warning" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="lowFoodMessage">N√≠vel de ra√ß√£o baixo!</span>
            </div>

            <!-- Card de N√≠vel de Comida -->
            <div class="card" id="foodLevelCard">
                <h3><i class="fas fa-box"></i> N√≠vel de Ra√ß√£o</h3>
                <div id="foodLevelContainer">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                    </div>
                </div>
            </div>

            <!-- Pet Cards -->
            <div class="pet-cards" id="petCards">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Carregando...
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h3>A√ß√µes R√°pidas</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showFeedNowModal()">
                        <i class="fas fa-utensils"></i> Alimentar Agora
                    </button>
                    <button class="btn btn-secondary" onclick="refreshFoodLevels()">
                        <i class="fas fa-ruler-vertical"></i> Verificar N√≠vel
                    </button>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Atualizar Tudo
                    </button>
                </div>
            </div>
        </div>

        <!-- Pets Tab -->
        <div id="petsTab" class="tab-content">
            <div class="section-header">
                <h2>Meus Pets</h2>
                <button class="btn btn-primary" onclick="showAddPetModal()">
                    <i class="fas fa-plus"></i> Adicionar Pet
                </button>
            </div>

            <div id="petsList">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Carregando pets...
                </div>
            </div>
        </div>

        <!-- Schedules Tab -->
        <div id="schedulesTab" class="tab-content">
            <div class="section-header">
                <h2>Hor√°rios Programados</h2>
                <button class="btn btn-primary" onclick="showAddScheduleModal()">
                    <i class="fas fa-plus"></i> Novo Hor√°rio
                </button>
            </div>

            <div id="schedulesList">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Carregando hor√°rios...
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content">
            <h2>Hist√≥rico de Alimenta√ß√£o</h2>

            <div class="filters">
                <select id="historyDeviceFilter" onchange="loadHistory()">
                    <option value="">Todos os dispositivos</option>
                </select>
                <select id="historyPetFilter" onchange="loadHistory()">
                    <option value="">Todos os pets</option>
                </select>
                <select id="historyDaysFilter" onchange="loadHistory()">
                    <option value="7">√öltimos 7 dias</option>
                    <option value="30">√öltimos 30 dias</option>
                    <option value="90">√öltimos 90 dias</option>
                </select>
            </div>

            <div id="historyList">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico...
                </div>
            </div>
        </div>

        <!-- Devices Tab -->
        <div id="devicesTab" class="tab-content">
            <div class="section-header">
                <h2>Dispositivos</h2>
                <button class="btn btn-primary" onclick="showLinkDeviceModal()">
                    <i class="fas fa-plus"></i> Vincular Dispositivo
                </button>
            </div>

            <!-- Como Configurar ESP32 -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                <h3><i class="fas fa-microchip"></i> Como Configurar seu ESP32</h3>

                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin: 15px 0;">
                    <!-- QR Code do WiFi -->
                    <div style="text-align: center; background: white; padding: 15px; border-radius: 12px;">
                        <img id="wifiQRCode"
                             src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=WIFI:T:WPA;S:PetFeeder-Setup;P:12345678;;&color=667eea"
                             alt="QR Code WiFi"
                             style="width: 120px; height: 120px;">
                        <p style="color: #333; font-size: 11px; margin-top: 8px; font-weight: bold;">
                            Escaneie para conectar<br>ao WiFi do ESP32
                        </p>
                    </div>

                    <!-- Informacoes -->
                    <div style="flex: 1; min-width: 200px;">
                        <p style="margin: 0 0 10px;">Seu email para vincular:</p>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                            <input type="text" id="userEmail" readonly
                                   style="flex: 1; padding: 10px; font-family: monospace; font-size: 13px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
                            <button class="btn" onclick="copyUserEmail()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); padding: 10px;">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div style="font-size: 11px; opacity: 0.9; line-height: 1.6;">
                            <strong>Passos:</strong><br>
                            1. Ligue o ESP32<br>
                            2. Escaneie o QR ou conecte em <strong>PetFeeder-Setup</strong><br>
                            3. Senha: <strong>12345678</strong><br>
                            4. Digite seu email e WiFi<br>
                            5. Pronto!
                        </div>
                    </div>
                </div>
            </div>

            <!-- Link para Guia de Montagem -->
            <div class="card" style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-book" style="font-size: 32px; color: #667eea;"></i>
                    <div style="flex: 1;">
                        <h3 style="margin: 0;">Guia de Montagem</h3>
                        <p style="margin: 5px 0 0; color: #666; font-size: 14px;">
                            Veja como conectar motores, sensor e configurar o ESP32
                        </p>
                    </div>
                    <a href="setup-guide.html" class="btn btn-primary">
                        <i class="fas fa-external-link-alt"></i> Abrir Guia
                    </a>
                </div>
            </div>

            <div id="devicesList">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Carregando dispositivos...
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

    <!-- Feed Now Modal - SIMPLIFICADO -->
    <div id="feedNowModal" class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-utensils"></i> Alimentar Agora</h3>
            <button class="modal-close" onclick="closeAllModals()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Selecione o Pet:</label>
                <select id="feedPetSelect" required onchange="updateFeedPetInfo()">
                    <option value="">Selecione um pet...</option>
                </select>
            </div>

            <!-- Info do pet selecionado -->
            <div id="feedPetInfo" class="pet-info-box" style="display: none;">
                <div class="info-row">
                    <span><i class="fas fa-microchip"></i> Dispositivo:</span>
                    <strong id="feedPetDevice">-</strong>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-box"></i> Compartimento:</span>
                    <strong id="feedPetCompartment">-</strong>
                </div>
            </div>

            <div class="form-group">
                <label>Tamanho da Dose:</label>
                <div class="dose-selector">
                    <label class="dose-option">
                        <input type="radio" name="feedDose" value="small" checked>
                        <div class="dose-card">
                            <i class="fas fa-drumstick-bite"></i>
                            <span class="dose-name">Pequena</span>
                            <span class="dose-amount">~50g</span>
                            <span class="dose-steps">1 volta</span>
                        </div>
                    </label>
                    <label class="dose-option">
                        <input type="radio" name="feedDose" value="medium">
                        <div class="dose-card">
                            <i class="fas fa-drumstick-bite"></i>
                            <i class="fas fa-drumstick-bite"></i>
                            <span class="dose-name">M√©dia</span>
                            <span class="dose-amount">~100g</span>
                            <span class="dose-steps">2 voltas</span>
                        </div>
                    </label>
                    <label class="dose-option">
                        <input type="radio" name="feedDose" value="large">
                        <div class="dose-card">
                            <i class="fas fa-drumstick-bite"></i>
                            <i class="fas fa-drumstick-bite"></i>
                            <i class="fas fa-drumstick-bite"></i>
                            <span class="dose-name">Grande</span>
                            <span class="dose-amount">~150g</span>
                            <span class="dose-steps">3 voltas</span>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAllModals()">Cancelar</button>
            <button class="btn btn-success" onclick="feedNow()">
                <i class="fas fa-play"></i> Alimentar Agora
            </button>
        </div>
    </div>

    <!-- Add Pet Modal - REORGANIZADO -->
    <div id="addPetModal" class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-paw"></i> Adicionar Pet</h3>
            <button class="modal-close" onclick="closeAllModals()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label><i class="fas fa-microchip"></i> Alimentador:</label>
                <select id="petDeviceSelect" required>
                    <option value="">Selecione o dispositivo...</option>
                </select>
                <div class="help-text">Qual alimentador este pet vai usar</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label><i class="fas fa-signature"></i> Nome do Pet:</label>
                    <input type="text" id="petName" placeholder="Ex: Thor, Luna..." required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-paw"></i> Tipo:</label>
                    <select id="petType" required>
                        <option value="cat">üê± Gato</option>
                        <option value="dog">üêï Cachorro</option>
                        <option value="bird">üê¶ P√°ssaro</option>
                        <option value="other">üêæ Outro</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label><i class="fas fa-box"></i> Compartimento:</label>
                    <select id="petCompartment" required>
                        <option value="1">Compartimento 1 (Motor 1)</option>
                        <option value="2">Compartimento 2 (Motor 2)</option>
                        <option value="3">Compartimento 3 (Motor 3)</option>
                    </select>
                    <div class="help-text">Cada pet usa um compartimento exclusivo</div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-weight"></i> Meta Di√°ria:</label>
                    <input type="number" id="petDailyAmount" min="10" max="1000" value="100" required>
                    <div class="help-text">Quantidade ideal em gramas/dia</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAllModals()">Cancelar</button>
            <button class="btn btn-primary" onclick="addPet()">
                <i class="fas fa-plus"></i> Adicionar Pet
            </button>
        </div>
    </div>

    <!-- Add Schedule Modal - SEM DUPLICATAS -->
    <div id="addScheduleModal" class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-clock"></i> Novo Hor√°rio</h3>
            <button class="modal-close" onclick="closeAllModals()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Selecione o Pet:</label>
                <select id="schedulePetSelect" required onchange="updateSchedulePetInfo()">
                    <option value="">Selecione um pet...</option>
                </select>
                <div class="help-text">O dispositivo e compartimento s√£o do pet</div>
            </div>

            <!-- Info do pet selecionado -->
            <div id="schedulePetInfo" class="pet-info-box" style="display: none;">
                <div class="info-row">
                    <span><i class="fas fa-microchip"></i> Dispositivo:</span>
                    <strong id="schedulePetDevice">-</strong>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-box"></i> Compartimento:</span>
                    <strong id="schedulePetCompartment">-</strong>
                </div>
            </div>

            <div class="form-group">
                <label><i class="fas fa-clock"></i> Hor√°rios:</label>
                <div id="scheduleTimesList">
                    <div class="time-input-row">
                        <input type="time" class="schedule-time-input" required>
                        <select class="schedule-dose-select">
                            <option value="">Usar global</option>
                            <option value="small">ü•Ñ Pequena (50g)</option>
                            <option value="medium">ü•£ M√©dia (100g)</option>
                            <option value="large">üçΩÔ∏è Grande (150g)</option>
                        </select>
                        <button type="button" class="btn btn-sm btn-danger remove-time-btn" onclick="removeTimeInput(this)" style="display:none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addTimeInput()" style="margin-top: 8px;">
                    <i class="fas fa-plus"></i> Adicionar outro hor√°rio
                </button>
                <div class="help-text">Adicione quantos hor√°rios quiser. Cada um pode ter dose diferente ou usar a global abaixo.</div>
            </div>

            <div class="form-group">
                <label>Dose Global (para hor√°rios sem dose individual):</label>
                <div class="dose-selector">
                    <label class="dose-option">
                        <input type="radio" name="scheduleDose" value="small">
                        <div class="dose-card">
                            <i class="fas fa-drumstick-bite"></i>
                            <span class="dose-name">Pequena</span>
                            <span class="dose-amount">~50g (1 volta)</span>
                        </div>
                    </label>
                    <label class="dose-option">
                        <input type="radio" name="scheduleDose" value="medium" checked>
                        <div class="dose-card">
                            <i class="fas fa-drumstick-bite"></i>
                            <i class="fas fa-drumstick-bite"></i>
                            <span class="dose-name">M√©dia</span>
                            <span class="dose-amount">~100g (2 voltas)</span>
                        </div>
                    </label>
                    <label class="dose-option">
                        <input type="radio" name="scheduleDose" value="large">
                        <div class="dose-card">
                            <i class="fas fa-drumstick-bite"></i>
                            <i class="fas fa-drumstick-bite"></i>
                            <i class="fas fa-drumstick-bite"></i>
                            <span class="dose-name">Grande</span>
                            <span class="dose-amount">~150g (3 voltas)</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Dias da Semana:</label>
                <div class="weekday-selector">
                    <label class="day-btn"><input type="checkbox" id="day_mon" checked><span>Seg</span></label>
                    <label class="day-btn"><input type="checkbox" id="day_tue" checked><span>Ter</span></label>
                    <label class="day-btn"><input type="checkbox" id="day_wed" checked><span>Qua</span></label>
                    <label class="day-btn"><input type="checkbox" id="day_thu" checked><span>Qui</span></label>
                    <label class="day-btn"><input type="checkbox" id="day_fri" checked><span>Sex</span></label>
                    <label class="day-btn"><input type="checkbox" id="day_sat" checked><span>S√°b</span></label>
                    <label class="day-btn"><input type="checkbox" id="day_sun" checked><span>Dom</span></label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAllModals()">Cancelar</button>
            <button class="btn btn-primary" onclick="addSchedule()">
                <i class="fas fa-plus"></i> Criar Hor√°rio
            </button>
        </div>
    </div>

    <!-- Link Device Modal -->
    <div id="linkDeviceModal" class="modal">
        <div class="modal-header">
            <h3>Vincular Dispositivo</h3>
            <button class="modal-close" onclick="closeAllModals()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ID do Dispositivo:</label>
                <input type="text" id="deviceId" placeholder="ESP32_XXXXXX" required>
                <div class="help-text">Digite o ID exibido no display do ESP32</div>
            </div>
            <div class="form-group">
                <label>Nome do Dispositivo:</label>
                <input type="text" id="deviceName" placeholder="Ex: Alimentador Sala" required>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAllModals()">Cancelar</button>
            <button class="btn btn-primary" onclick="linkDevice()">Vincular</button>
        </div>
    </div>

    <!-- Edit Device Modal -->
    <div id="editDeviceModal" class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Editar Dispositivo</h3>
            <button class="modal-close" onclick="closeAllModals()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editDeviceId">
            <div class="form-group">
                <label>Nome do Dispositivo:</label>
                <input type="text" id="editDeviceName" placeholder="Ex: Alimentador Sala" required>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAllModals()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveDeviceEdit()">
                <i class="fas fa-save"></i> Salvar
            </button>
        </div>
    </div>

    <!-- Edit Pet Modal -->
    <div id="editPetModal" class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-paw"></i> Editar Pet</h3>
            <button class="modal-close" onclick="closeAllModals()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editPetId">
            <div class="form-group">
                <label><i class="fas fa-signature"></i> Nome:</label>
                <input type="text" id="editPetName" placeholder="Nome do pet" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label><i class="fas fa-paw"></i> Tipo:</label>
                    <select id="editPetType">
                        <option value="dog">Cachorro</option>
                        <option value="cat">Gato</option>
                        <option value="other">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-box"></i> Compartimento:</label>
                    <select id="editPetCompartment">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label><i class="fas fa-weight"></i> Quantidade Diaria (g):</label>
                <input type="number" id="editPetDailyAmount" min="10" max="500" value="100">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAllModals()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveEditPet()">
                <i class="fas fa-save"></i> Salvar
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/websocket.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
